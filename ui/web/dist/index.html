<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ichimi Server</title>
  <!-- Tabler CSS -->
  <link rel="stylesheet" href="tabler-css/tabler.min.css">
  <!-- Tabler Icons -->
  <link rel="stylesheet" href="tabler-icons/tabler-icons.min.css">
  <!-- Custom styles -->
  <style>
    /* „Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
    .navbar-brand-image {
      height: 2rem;
    }

    .process-card {
      transition: transform 0.2s;
    }

    .process-card:hover {
      transform: translateY(-2px);
    }

    /* 2ÊÆµÁõÆ„ÅÆ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éê„Éº */
    .navbar-stats {
      background-color: var(--tblr-bg-surface-secondary);
      border-bottom: 1px solid var(--tblr-border-color);
      padding: 0.5rem 0;
    }

    .stat-item {
      display: flex;
      align-items: center;
      padding: 0 1rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--tblr-secondary);
      margin-right: 0.5rem;
      text-transform: uppercase;
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .stat-divider {
      width: 1px;
      height: 2rem;
      background-color: var(--tblr-border-color);
      margin: 0 1rem;
    }
  </style>
  <!-- Alpine.js -->
  <script defer src="alpine.min.js"></script>
  <!-- App Logic -->
  <script src="index.js"></script>
</head>

<body x-data="{ currentView: 'dashboard' }" x-init="$store.state.init()">
  <div class="page">
    <!-- Navbar -->
    <header class="navbar navbar-expand-md navbar-light d-print-none">
      <div class="container-xl">
        <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
          <a href="#">
            üöÄ Ichimi Server
          </a>
        </h1>
        <div class="navbar-nav flex-row order-md-last">
          <div class="nav-item">
            <button @click="$store.state.toggleMode()" class="btn btn-ghost-secondary btn-icon"
              :title="'Switch to ' + ($store.state.mode === 'light' ? 'dark' : 'light') + ' mode'">
              <i x-show="$store.state.mode === 'dark'" class="ti ti-sun"></i>
              <i x-show="$store.state.mode === 'light'" class="ti ti-moon"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation with Process Stats -->
    <div class="navbar-expand-md">
      <div class="navbar navbar-light">
        <div class="container-xl">
          <ul class="navbar-nav">
            <li class="nav-item" :class="{ active: currentView === 'dashboard' }">
              <a class="nav-link" href="#" @click="currentView = 'dashboard'">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <i class="ti ti-home"></i>
                </span>
                <span class="nav-link-title">Dashboard</span>
              </a>
            </li>
            <li class="nav-item" :class="{ active: currentView === 'processes' }">
              <a class="nav-link" href="#" @click="currentView = 'processes'">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <i class="ti ti-activity"></i>
                </span>
                <span class="nav-link-title">Processes</span>
              </a>
            </li>
            <li class="nav-item" :class="{ active: currentView === 'templates' }">
              <a class="nav-link" href="#" @click="currentView = 'templates'">
                <span class="nav-link-icon d-md-none d-lg-inline-block">
                  <i class="ti ti-template"></i>
                </span>
                <span class="nav-link-title">Templates</span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Process Stats Bar -->
    <div class="navbar-stats">
      <div class="container-xl">
        <div class="d-flex align-items-center">
          <!-- Total Processes -->
          <div class="stat-item">
            <span class="stat-label">Total</span>
            <span class="stat-value" x-text="$store.state.processes.length">0</span>
          </div>
          
          <div class="stat-divider"></div>
          
          <!-- Running -->
          <div class="stat-item">
            <span class="stat-label">Running</span>
            <span class="stat-value text-green" 
                  x-text="$store.state.processes.filter(p => p.state?.state === 'Running').length">0</span>
          </div>
          
          <div class="stat-divider"></div>
          
          <!-- Stopped -->
          <div class="stat-item">
            <span class="stat-label">Stopped</span>
            <span class="stat-value text-yellow" 
                  x-text="$store.state.processes.filter(p => p.state?.state === 'Stopped').length">0</span>
          </div>
          
          <div class="stat-divider"></div>
          
          <!-- Failed -->
          <div class="stat-item">
            <span class="stat-label">Failed</span>
            <span class="stat-value text-red" 
                  x-text="$store.state.processes.filter(p => p.state?.state === 'Failed').length">0</span>
          </div>

          <!-- Quick Actions (Right aligned) -->
          <div class="ms-auto d-flex">
            <button @click="$store.state.loadProcesses()" class="btn btn-sm btn-ghost-secondary" title="Refresh">
              <i class="ti ti-refresh"></i>
            </button>
            <button @click="$store.state.addTestProcesses()" 
                    class="btn btn-sm btn-ghost-primary ms-2"
                    :disabled="$store.state.addingTestProcess"
                    title="Add test processes for demo/testing">
              <i class="ti ti-test-pipe"></i> Add Test
            </button>
            <button @click="currentView = 'templates'; $store.state.selectProcessTemplate && $store.state.selectProcessTemplate($store.state.processTemplates[0])" 
                    class="btn btn-sm btn-primary ms-2"
                    x-show="$store.state.processTemplates && $store.state.processTemplates.length > 0">
              <i class="ti ti-plus"></i> New Process
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Page Content -->
    <div class="page-wrapper">
      <!-- Dashboard View -->
      <div x-show="currentView === 'dashboard'" x-transition>
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">Dashboard</h2>
              </div>
            </div>
          </div>
        </div>

        <div class="page-body">
          <div class="container-xl">
            <!-- Error Alert -->
            <div x-show="$store.state.processesError" class="alert alert-danger" x-text="$store.state.processesError"></div>

            <!-- Loading State -->
            <div x-show="$store.state.processesLoading" class="text-center">
              <div class="spinner-border" role="status"></div>
            </div>

            <!-- Empty State -->
            <div x-show="!$store.state.processesLoading && $store.state.processes.length === 0" class="empty">
              <p class="empty-title">No processes found</p>
              <p class="empty-subtitle text-muted">Create your first process from a template</p>
              <div class="empty-action">
                <button @click="currentView = 'templates'; $store.state.showProcessTemplateModal = true"
                  class="btn btn-primary">
                  <i class="ti ti-plus"></i> Create Process
                </button>
              </div>
            </div>

            <!-- Process List -->
            <div class="row row-cards" x-show="!$store.state.processesLoading && $store.state.processes.length > 0">
              <template x-for="process in $store.state.processes" :key="process.id">
                <div class="col-12">
                  <div class="card process-card">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col">
                          <h3 class="mb-1" x-text="process.id"></h3>
                          <div class="text-muted">
                            <code x-text="process.command + ' ' + process.args.join(' ')"></code>
                          </div>
                          <div class="mt-2">
                            <span class="badge" :class="{
                                    'bg-green': process.state === 'NotStarted' ? false : process.state?.Running,
                                    'bg-yellow': process.state === 'NotStarted' ? false : process.state?.Stopped,
                                    'bg-red': process.state === 'NotStarted' ? false : process.state?.Failed,
                                    'bg-secondary': process.state === 'NotStarted'
                                  }" x-text="process.state === 'NotStarted' ? 'NotStarted' : 
                                         (process.state?.Running ? 'Running' : 
                                          (process.state?.Stopped ? 'Stopped' : 
                                           (process.state?.Failed ? 'Failed' : 'Unknown')))"></span>
                            <span x-show="process.state?.Running?.pid" class="ms-2 text-muted">
                              PID: <span x-text="process.state?.Running?.pid"></span>
                            </span>
                          </div>
                        </div>
                        <div class="col-auto">
                          <div class="btn-list">
                            <button @click="$store.state.startProcess(process.id)" class="btn btn-green"
                              :disabled="process.state !== 'NotStarted' && process.state?.Running">
                              <i class="ti ti-player-play"></i> Start
                            </button>
                            <button @click="$store.state.stopProcess(process.id)" class="btn btn-yellow"
                              :disabled="!(process.state !== 'NotStarted' && process.state?.Running)">
                              <i class="ti ti-player-stop"></i> Stop
                            </button>
                            <button @click="$store.state.removeProcess(process.id)" class="btn btn-red"
                              :disabled="process.state?.state === 'Running'">
                              <i class="ti ti-trash"></i> Remove
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Processes View -->
      <div x-show="currentView === 'processes'" x-transition>
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">Processes</h2>
              </div>
              <div class="col-auto ms-auto d-print-none">
                <button @click="$store.state.loadProcesses()" class="btn btn-primary">
                  <i class="ti ti-refresh"></i> Refresh
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="page-body">
          <div class="container-xl">
            <!-- Error Alert -->
            <div x-show="$store.state.processesError" class="alert alert-danger" x-text="$store.state.processesError">
            </div>

            <!-- Loading State -->
            <div x-show="$store.state.processesLoading" class="text-center">
              <div class="spinner-border" role="status"></div>
            </div>

            <!-- Empty State -->
            <div x-show="!$store.state.processesLoading && $store.state.processes.length === 0" class="empty">
              <p class="empty-title">No processes found</p>
              <p class="empty-subtitle text-muted">Create your first process from a template</p>
              <div class="empty-action">
                <button @click="currentView = 'templates'; $store.state.showProcessTemplateModal = true"
                  class="btn btn-primary">
                  <i class="ti ti-plus"></i> Create Process
                </button>
              </div>
            </div>

            <!-- Process List -->
            <div class="row row-cards" x-show="!$store.state.processesLoading && $store.state.processes.length > 0">
              <template x-for="process in $store.state.processes" :key="process.id">
                <div class="col-12">
                  <div class="card process-card">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col">
                          <h3 class="mb-1" x-text="process.id"></h3>
                          <div class="text-muted">
                            <code x-text="process.command + ' ' + process.args.join(' ')"></code>
                          </div>
                          <div class="mt-2">
                            <span class="badge" :class="{
                                    'bg-green': process.state === 'NotStarted' ? false : process.state?.Running,
                                    'bg-yellow': process.state === 'NotStarted' ? false : process.state?.Stopped,
                                    'bg-red': process.state === 'NotStarted' ? false : process.state?.Failed,
                                    'bg-secondary': process.state === 'NotStarted'
                                  }" x-text="process.state === 'NotStarted' ? 'NotStarted' : 
                                         (process.state?.Running ? 'Running' : 
                                          (process.state?.Stopped ? 'Stopped' : 
                                           (process.state?.Failed ? 'Failed' : 'Unknown')))"></span>
                            <span x-show="process.state?.Running?.pid" class="ms-2 text-muted">
                              PID: <span x-text="process.state?.Running?.pid"></span>
                            </span>
                          </div>
                        </div>
                        <div class="col-auto">
                          <div class="btn-list">
                            <button @click="$store.state.startProcess(process.id)" class="btn btn-green"
                              :disabled="process.state !== 'NotStarted' && process.state?.Running">
                              <i class="ti ti-player-play"></i> Start
                            </button>
                            <button @click="$store.state.stopProcess(process.id)" class="btn btn-yellow"
                              :disabled="!(process.state !== 'NotStarted' && process.state?.Running)">
                              <i class="ti ti-player-stop"></i> Stop
                            </button>
                            <button @click="$store.state.removeProcess(process.id)" class="btn btn-red"
                              :disabled="process.state?.state === 'Running'">
                              <i class="ti ti-trash"></i> Remove
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Templates View -->
      <div x-show="currentView === 'templates'" x-transition>
        <div class="page-header d-print-none">
          <div class="container-xl">
            <div class="row g-2 align-items-center">
              <div class="col">
                <h2 class="page-title">Templates</h2>
              </div>
              <div class="col-auto ms-auto d-print-none">
                <button @click="$store.state.showProcessTemplateModal = true" class="btn btn-primary">
                  <i class="ti ti-plus"></i> Create Process
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="page-body">
          <div class="container-xl">
            <div class="row row-cards">
              <template x-for="template in $store.state.processTemplates" :key="template.template_id">
                <div class="col-md-6 col-lg-4">
                  <div class="card">
                    <div class="card-body">
                      <h3 class="card-title" x-text="template.name"></h3>
                      <p class="text-muted" x-text="template.description"></p>
                      <div class="mt-3">
                        <button @click="$store.state.selectProcessTemplate(template)" class="btn btn-primary w-100">
                          Use Template
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Template Modal -->
        <div x-show="$store.state.showProcessTemplateModal" class="modal modal-blur fade show" style="display: block;"
          @click.self="$store.state.closeProcessTemplateModal()">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Create Process from Template</h5>
                <button type="button" class="btn-close" @click="$store.state.closeProcessTemplateModal()"></button>
              </div>
              <div class="modal-body">
                <!-- Template Selection -->
                <div x-show="!$store.state.selectedProcessTemplate">
                  <h3>Select a Template</h3>
                  <div class="row g-3">
                    <template x-for="template in $store.state.processTemplates" :key="template.template_id">
                      <div class="col-12">
                        <div class="card cursor-pointer" @click="$store.state.selectProcessTemplate(template)">
                          <div class="card-body">
                            <h4 x-text="template.name"></h4>
                            <p class="text-muted" x-text="template.description"></p>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- Configuration -->
                <div x-show="$store.state.selectedProcessTemplate">
                  <h3>Configure Process</h3>
                  <div class="mb-3">
                    <label class="form-label">Process ID</label>
                    <input type="text" class="form-control" x-model="$store.state.processTemplateId">
                  </div>

                  <template x-for="variable in $store.state.selectedProcessTemplate?.variables || []"
                    :key="variable.name">
                    <div class="mb-3">
                      <label class="form-label">
                        <span x-text="variable.name"></span>
                        <span x-show="variable.required" class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control"
                        x-model="$store.state.processTemplateVariableValues[variable.name]">
                      <small class="form-hint" x-text="variable.description"></small>
                    </div>
                  </template>
                </div>

                <div x-show="$store.state.processTemplatesError" class="alert alert-danger"
                  x-text="$store.state.processTemplatesError"></div>
              </div>
              <div class="modal-footer">
                <button @click="$store.state.closeProcessTemplateModal()" class="btn btn-secondary">Cancel</button>
                <button @click="$store.state.instantiateProcessTemplate()" class="btn btn-primary"
                  x-show="$store.state.selectedProcessTemplate">
                  Create Process
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>